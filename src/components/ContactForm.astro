---
import { Hand } from 'lucide-react';
// ContactForm.astro - Get in Touch Section
---

<section id="get-in-touch" class="py-24 relative">
	<div class="max-w-7xl mx-auto px-6">
		<!-- Section Header -->
		<div class="mb-16 text-center">
			<h2 class="contact-heading text-5xl md:text-6xl font-extrabold tracking-tighter mb-6">
				Let's Work Together
			</h2>
			<p class="contact-subheading text-lg text-white/60 max-w-2xl mx-auto">
				Have a project in mind? Let's create something amazing together.
			</p>
		</div>

		<!-- Form Container with 3D Tilt Effect -->
		<div class="form-container-wrapper perspective-1000">
			<div class="form-container max-w-5xl mx-auto rounded-3xl bg-premium-gray border border-white/10 overflow-hidden backdrop-blur-sm">
				<!-- Gradient overlay -->
				<div class="absolute inset-0 bg-gradient-to-br from-blue-accent/5 to-transparent pointer-events-none"></div>
				
				<div class="grid md:grid-cols-5 gap-8 md:gap-12 p-8 md:p-12 relative z-10">
					<!-- Left Column - Info -->
					<div class="md:col-span-2 form-info">
						<div class="sticky top-8">
							<h3 class="dynamic-greeting text-3xl font-bold mb-4 flex items-center gap-2">
								Hey <span class="text-blue-accent greeting-name">there</span>! <Hand className="w-7 h-7 text-blue-accent" />
							</h3>
							<p class="text-white/60 mb-6 leading-relaxed">
								Fill out the form and I'll get back to you as soon as possible. Looking forward to hearing from you!
							</p>
							
							<!-- Contact Info -->
							<div class="space-y-4">
								<div class="flex items-center gap-3 text-sm text-white/50">
									<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
										<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
										<polyline points="22,6 12,13 2,6"></polyline>
									</svg>
									<span>kirilpetrovski2005@gmail.com</span>
								</div>
								<div class="flex items-center gap-3 text-sm text-white/50">
									<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
										<path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
										<circle cx="12" cy="10" r="3"></circle>
									</svg>
									<span>Madrid, Spain</span>
								</div>
								<div class="flex items-center gap-3 text-sm text-white/50">
									<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
										<circle cx="12" cy="12" r="10"></circle>
										<polyline points="12 6 12 12 16 14"></polyline>
									</svg>
									<span>Usually responds within 24h</span>
								</div>
							</div>
						</div>
					</div>

					<!-- Right Column - Form -->
					<div class="md:col-span-3">
						<form id="contact-form" class="space-y-6">
							<!-- Name Field -->
							<div class="form-field opacity-0">
								<label for="name" class="block text-sm font-medium text-white/80 mb-2">
									Your Name <span class="text-blue-accent">*</span>
								</label>
								<input
									type="text"
									id="name"
									name="name"
									required
									class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/30 focus:outline-none focus:border-blue-accent/50 focus:bg-white/10 transition-all duration-300"
									placeholder="John Doe"
								/>
							</div>

							<!-- Email Field -->
							<div class="form-field opacity-0">
								<label for="email" class="block text-sm font-medium text-white/80 mb-2">
									Email Address <span class="text-blue-accent">*</span>
								</label>
								<input
									type="email"
									id="email"
									name="email"
									required
									class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/30 focus:outline-none focus:border-blue-accent/50 focus:bg-white/10 transition-all duration-300"
									placeholder="john@example.com"
								/>
								<p id="email-validation" class="text-xs mt-1 transition-all duration-300"></p>
							</div>

							<!-- Message Field -->
							<div class="form-field opacity-0">
								<label for="message" class="flex items-center justify-between text-sm font-medium text-white/80 mb-2">
									<span>Your Message <span class="text-blue-accent">*</span></span>
									<span id="char-counter" class="text-xs text-white/40">0 / 500</span>
								</label>
								<textarea
									id="message"
									name="message"
									required
									rows="5"
									maxlength="500"
									class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/30 focus:outline-none focus:border-blue-accent/50 focus:bg-white/10 transition-all duration-300 resize-none"
									placeholder="Tell me about your project..."
								></textarea>
							</div>

							<!-- Captcha -->
							<div class="form-field opacity-0">
								<label for="captcha" class="block text-sm font-medium text-white/80 mb-3">
									Security Check <span class="text-blue-accent">*</span>
								</label>
								<div class="flex items-center gap-3">
									<div class="captcha-box flex items-center gap-3 px-6 py-3 rounded-xl bg-blue-accent/10 border border-blue-accent/30">
										<span id="captcha-num1" class="text-2xl font-bold text-blue-accent">5</span>
										<span class="text-white/50 text-xl">+</span>
										<span id="captcha-num2" class="text-2xl font-bold text-blue-accent">3</span>
										<span class="text-white/50 text-xl">=</span>
									</div>
									<input
										type="number"
										id="captcha"
										name="captcha"
										required
										class="w-24 px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/30 focus:outline-none focus:border-blue-accent/50 focus:bg-white/10 transition-all duration-300 text-center"
										placeholder="?"
									/>
									<button
										type="button"
										id="refresh-captcha"
										class="p-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 hover:border-blue-accent/30 transition-all duration-300"
										aria-label="Refresh captcha"
									>
										<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white/60">
											<polyline points="23 4 23 10 17 10"></polyline>
											<polyline points="1 20 1 14 7 14"></polyline>
											<path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
										</svg>
									</button>
								</div>
								<p id="captcha-error" class="text-xs mt-1 text-red-400 opacity-0 transition-opacity duration-300"></p>
							</div>

							<!-- Submit Button -->
							<div class="form-field opacity-0">
								<button
									type="submit"
									id="submit-btn"
									class="submit-btn w-full md:w-auto px-8 py-4 rounded-full bg-blue-accent hover:bg-blue-accent-dark text-white font-medium transition-all duration-500 flex items-center justify-center gap-2 group"
								>
									<span>Send Message</span>
									<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300 group-hover:translate-x-1">
										<line x1="22" y1="2" x2="11" y2="13"></line>
										<polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
									</svg>
								</button>
							</div>
						</form>

						<!-- Success Message -->
						<div id="success-message" class="hidden mt-8 p-6 rounded-xl bg-green-500/10 border border-green-500/30">
							<div class="flex items-start gap-3">
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400 flex-shrink-0 mt-0.5">
									<polyline points="20 6 9 17 4 12"></polyline>
								</svg>
								<div>
									<h4 class="text-green-400 font-semibold mb-1">Message Sent Successfully!</h4>
									<p class="text-white/60 text-sm">Thanks for reaching out! I'll get back to you as soon as possible.</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Confetti Canvas -->
	<canvas id="confetti-canvas" class="fixed inset-0 pointer-events-none z-50 hidden"></canvas>
</section>

<style>
	.perspective-1000 {
		perspective: 1000px;
	}

	.form-container {
		position: relative;
		transition: transform 0.3s ease;
		transform-style: preserve-3d;
	}

	/* Input focus glow effect */
	input:focus, textarea:focus {
		box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 0 20px rgba(59, 130, 246, 0.2);
	}

	/* Submit button morph */
	.submit-btn {
		box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
	}

	.submit-btn:hover {
		transform: scale(1.02);
		box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);
	}

	.submit-btn:active {
		transform: scale(0.98);
	}

	/* Captcha shake animation */
	@keyframes shake {
		0%, 100% { transform: translateX(0); }
		10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
		20%, 40%, 60%, 80% { transform: translateX(5px); }
	}

	.captcha-box.shake {
		animation: shake 0.5s;
	}

	/* Character counter color transitions */
	#char-counter.good {
		color: rgb(34, 197, 94);
	}

	#char-counter.warning {
		color: rgb(251, 191, 36);
	}

	#char-counter.danger {
		color: rgb(239, 68, 68);
	}
</style>

<script>
	import { gsap } from 'gsap';
	import { ScrollTrigger } from 'gsap/ScrollTrigger';

	gsap.registerPlugin(ScrollTrigger);

	// Captcha state
	let captchaNum1 = 0;
	let captchaNum2 = 0;

	// Generate random captcha
	function generateCaptcha() {
		captchaNum1 = Math.floor(Math.random() * 10) + 1;
		captchaNum2 = Math.floor(Math.random() * 10) + 1;
		
		const num1El = document.getElementById('captcha-num1');
		const num2El = document.getElementById('captcha-num2');
		
		if (num1El && num2El) {
			num1El.textContent = captchaNum1.toString();
			num2El.textContent = captchaNum2.toString();
		}
	}

	// Initialize captcha on load
	generateCaptcha();

	// Refresh captcha button
	const refreshBtn = document.getElementById('refresh-captcha');
	refreshBtn?.addEventListener('click', () => {
		generateCaptcha();
		const captchaInput = document.getElementById('captcha') as HTMLInputElement;
		if (captchaInput) captchaInput.value = '';
		const errorEl = document.getElementById('captcha-error');
		if (errorEl) errorEl.style.opacity = '0';
	});

	// Dynamic greeting based on name input
	const nameInput = document.getElementById('name') as HTMLInputElement;
	const greetingName = document.querySelector('.greeting-name');

	nameInput?.addEventListener('input', (e) => {
		const name = (e.target as HTMLInputElement).value.trim();
		if (greetingName) {
			greetingName.textContent = name || 'there';
			gsap.to(greetingName, { scale: 1.1, duration: 0.2, yoyo: true, repeat: 1 });
		}
	});

	// Email validation with color feedback
	const emailInput = document.getElementById('email') as HTMLInputElement;
	const emailValidation = document.getElementById('email-validation');
	
	emailInput?.addEventListener('input', (e) => {
		const email = (e.target as HTMLInputElement).value;
		const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
		
		if (emailValidation) {
			if (email.length === 0) {
				emailValidation.textContent = '';
			} else if (isValid) {
				emailValidation.textContent = '✓ Valid email';
				emailValidation.style.color = 'rgb(34, 197, 94)';
			} else {
				emailValidation.textContent = '✗ Invalid email format';
				emailValidation.style.color = 'rgb(239, 68, 68)';
			}
		}
	});

	// Character counter with color changes
	const messageInput = document.getElementById('message') as HTMLTextAreaElement;
	const charCounter = document.getElementById('char-counter');

	messageInput?.addEventListener('input', (e) => {
		const length = (e.target as HTMLTextAreaElement).value.length;
		if (charCounter) {
			charCounter.textContent = `${length} / 500`;
			
			// Remove all classes
			charCounter.classList.remove('good', 'warning', 'danger');
			
			// Add appropriate class
			if (length < 200) {
				// Default color
			} else if (length < 400) {
				charCounter.classList.add('good');
			} else if (length < 480) {
				charCounter.classList.add('warning');
			} else {
				charCounter.classList.add('danger');
			}
		}
	});

	// Form submission
	const form = document.getElementById('contact-form') as HTMLFormElement;
	const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
	const successMessage = document.getElementById('success-message');

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();

		// Validate captcha
		const captchaInput = document.getElementById('captcha') as HTMLInputElement;
		const captchaValue = parseInt(captchaInput?.value || '0');
		const correctAnswer = captchaNum1 + captchaNum2;

		if (captchaValue !== correctAnswer) {
			const captchaBox = document.querySelector('.captcha-box');
			const errorEl = document.getElementById('captcha-error');
			
			if (captchaBox) {
				captchaBox.classList.add('shake');
				setTimeout(() => captchaBox.classList.remove('shake'), 500);
			}
			
			if (errorEl) {
				errorEl.textContent = 'Incorrect answer. Please try again.';
				errorEl.style.opacity = '1';
			}
			
			generateCaptcha();
			captchaInput.value = '';
			return;
		}

		// Disable submit button
		if (submitBtn) {
			submitBtn.disabled = true;
			submitBtn.innerHTML = '<span>Sending...</span>';
		}

		// Get form data
		const formData = new FormData(form);
		const data = {
			name: formData.get('name'),
			email: formData.get('email'),
			message: formData.get('message'),
			access_key: '1fcd03d2-c435-45df-8751-d71751521a3d'
		};

		try {
			// Send to Web3Forms
			const response = await fetch('https://api.web3forms.com/submit', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Accept': 'application/json'
				},
				body: JSON.stringify(data)
			});

			const result = await response.json();

			if (result.success) {
				// Show success message
				form.classList.add('hidden');
				if (successMessage) {
					successMessage.classList.remove('hidden');
					gsap.from(successMessage, {
						opacity: 0,
						y: 20,
						duration: 0.6,
						ease: 'back.out(1.5)'
					});
				}

				// Trigger confetti
				triggerConfetti();
			} else {
				throw new Error('Form submission failed');
			}

		} catch (error) {
			console.error('Error sending message:', error);
			alert('Sorry, there was an error sending your message. Please try emailing me directly at kirilpetrovski2005@gmail.com');
		} finally {
			if (submitBtn) {
				submitBtn.disabled = false;
				submitBtn.innerHTML = '<span>Send Message</span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300 group-hover:translate-x-1"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>';
			}
		}
	});

	// Confetti effect
	function triggerConfetti() {
		const canvas = document.getElementById('confetti-canvas') as HTMLCanvasElement;
		if (!canvas) return;

		canvas.classList.remove('hidden');
		const ctx = canvas.getContext('2d');
		if (!ctx) return;

		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;

		const particles: Array<{
			x: number;
			y: number;
			vx: number;
			vy: number;
			color: string;
			size: number;
		}> = [];

		const colors = ['#3b82f6', '#60a5fa', '#93c5fd', '#dbeafe', '#ffffff'];

		// Create particles
		for (let i = 0; i < 100; i++) {
			particles.push({
				x: canvas.width / 2,
				y: canvas.height / 2,
				vx: (Math.random() - 0.5) * 10,
				vy: (Math.random() - 0.5) * 10 - 5,
				color: colors[Math.floor(Math.random() * colors.length)],
				size: Math.random() * 5 + 2
			});
		}

		function animate() {
			if (!ctx || !canvas) return;
			
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			particles.forEach((p, index) => {
				p.x += p.vx;
				p.y += p.vy;
				p.vy += 0.2; // Gravity

				if (ctx) {
					ctx.fillStyle = p.color;
					ctx.fillRect(p.x, p.y, p.size, p.size);
				}

				// Remove particles that are off screen
				if (p.y > canvas.height) {
					particles.splice(index, 1);
				}
			});

			if (particles.length > 0) {
				requestAnimationFrame(animate);
			} else {
				canvas.classList.add('hidden');
			}
		}

		animate();
	}

	// GSAP Scroll Animations
	gsap.set('.contact-heading, .contact-subheading', { opacity: 1, y: 0 });
	
	gsap.from('.contact-heading', {
		scrollTrigger: {
			trigger: '#get-in-touch',
			start: 'top 80%',
			toggleActions: 'play none none none',
			once: true
		},
		y: 40,
		opacity: 0,
		duration: 0.8,
		ease: 'power3.out'
	});

	gsap.from('.contact-subheading', {
		scrollTrigger: {
			trigger: '#get-in-touch',
			start: 'top 80%',
			toggleActions: 'play none none none',
			once: true
		},
		y: 30,
		opacity: 0,
		duration: 0.8,
		delay: 0.2,
		ease: 'power3.out'
	});

	// Form container slide up
	gsap.from('.form-container', {
		scrollTrigger: {
			trigger: '.form-container',
			start: 'top 85%',
			toggleActions: 'play none none none',
			once: true
		},
		y: 60,
		opacity: 0,
		duration: 1,
		ease: 'power3.out'
	});

	// Stagger form fields from different directions
	const formFields = document.querySelectorAll('.form-field');
	
	formFields.forEach((field, index) => {
		const direction = index % 2 === 0 ? -40 : 40; // Alternate left/right
		
		gsap.to(field, {
			scrollTrigger: {
				trigger: '.form-container',
				start: 'top 80%',
				toggleActions: 'play none none none',
				once: true
			},
			x: 0,
			opacity: 1,
			duration: 0.8,
			delay: 0.3 + (index * 0.1),
			ease: 'back.out(1.2)',
			onStart: () => {
				gsap.set(field, { x: direction });
			}
		});
	});

	// Info section animation
	gsap.from('.form-info', {
		scrollTrigger: {
			trigger: '.form-container',
			start: 'top 80%',
			toggleActions: 'play none none none',
			once: true
		},
		x: -40,
		opacity: 0,
		duration: 1,
		ease: 'power3.out',
		delay: 0.2
	});

	// 3D tilt effect on mouse move (desktop only)
	if (window.innerWidth > 768) {
		const formContainer = document.querySelector('.form-container') as HTMLElement;
		const wrapper = document.querySelector('.form-container-wrapper') as HTMLElement;

		wrapper?.addEventListener('mousemove', (e) => {
			const rect = wrapper.getBoundingClientRect();
			const x = e.clientX - rect.left;
			const y = e.clientY - rect.top;
			
			const centerX = rect.width / 2;
			const centerY = rect.height / 2;
			
			const rotateX = (y - centerY) / 30;
			const rotateY = (centerX - x) / 30;

			if (formContainer) {
				formContainer.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
			}
		});

		wrapper?.addEventListener('mouseleave', () => {
			if (formContainer) {
				formContainer.style.transform = 'rotateX(0) rotateY(0) scale(1)';
			}
		});
	}
</script>
